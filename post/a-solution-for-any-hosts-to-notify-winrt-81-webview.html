<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>让WinRT 8.1 Webview支持任意站点下的JS通知 | @chaoming.edc blog</title>
  <meta name="author" content="chaoming.edc|blastmann">
  
  <meta name="description" content="track my learning">
  
  
  <meta name="keywords" content="windowsphone,windows,xaml,developer,iOS,OSX,productive">
  
  
  <meta property="og:title" content="让WinRT 8.1 Webview支持任意站点下的JS通知"/>
  <meta name="title" content="让WinRT 8.1 Webview支持任意站点下的JS通知"/>

  <meta property="displaydate" content="2014-08-04T14:10:00.000Z"/>

  <meta property="og:site_name" content="@chaoming.edc blog"/>
  <meta name="copyright" content="@chaoming.edc blog"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta property="og:image" content="undefined"/>
  
   <meta name="google-site-verification" content="nTpmJEYYJgba5eVrpd_dfj1W_Ayr-NjZ1vFvhi5aqzI" />
   <meta name="baidu-site-verification" content="QO84kHVH0w" />
   <link rel="apple-touch-icon" href="/icon.png" />
   <link rel="shortcut icon" href="/favicon.png" >
   <link rel="alternate" href="http://blog.edi-c.com/atom.xml" title="@chaoming.edc blog" type="application/atom+xml">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
</head>


<body>
  <div id="content" class="inner">
    <aside id="sidebar" class="alignleft">
      <div class="navigationBar">
        <a href="/">@chaoming.edc blog</a>
      </div>
    	
  <nav class="widget" id="menu">
	<ul>
    
      <li class="cell"><a class="next" href="/">Home</a><li>
    
      <li class="cell"><a class="next" href="/archives/">Archives</a><li>
    
      <li class="cell"><a class="next" href="/about/">About</a><li>
    
      <li class="cell"><a class="next" href="/atom.xml">Subscribe</a><li>
    
    </ul>
</nav>

  <div class="widget weibo">
<iframe width="100%" height="100" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=110&fansRow=2&ptype=1&speed=0&skin=1&isTitle=1&noborder=0&isWeibo=0&isFans=0&uid=newdings&verifier=78e1ee4d&colors=ffffff,ffffff,999,000,ecfbfd&dpc=1"></iframe>
</div>

  

  
<div class="widget tagcloud">
  <h3 class="title">标签云</h3>
  <div class="entry">
    <a href="/tags/IE/" style="font-size: 10.00px;">IE</a><a href="/tags/Swift/" style="font-size: 10.00px;">Swift</a><a href="/tags/WPF/" style="font-size: 10.00px;">WPF</a><a href="/tags/alfred/" style="font-size: 10.00px;">alfred</a><a href="/tags/aspnet/" style="font-size: 10.00px;">aspnet</a><a href="/tags/browser/" style="font-size: 10.00px;">browser</a><a href="/tags/csharp/" style="font-size: 10.00px;">csharp</a><a href="/tags/css3/" style="font-size: 12.50px;">css3</a><a href="/tags/dev/" style="font-size: 10.00px;">dev</a><a href="/tags/diary/" style="font-size: 10.00px;">diary</a><a href="/tags/directx/" style="font-size: 10.00px;">directx</a><a href="/tags/fiddler/" style="font-size: 12.50px;">fiddler</a><a href="/tags/google/" style="font-size: 10.00px;">google</a><a href="/tags/iOS/" style="font-size: 10.00px;">iOS</a><a href="/tags/ie/" style="font-size: 10.00px;">ie</a><a href="/tags/ie11/" style="font-size: 10.00px;">ie11</a><a href="/tags/javascript/" style="font-size: 10.00px;">javascript</a><a href="/tags/js/" style="font-size: 10.00px;">js</a><a href="/tags/keyboard/" style="font-size: 10.00px;">keyboard</a><a href="/tags/mac/" style="font-size: 10.00px;">mac</a><a href="/tags/markdown/" style="font-size: 10.00px;">markdown</a><a href="/tags/mvc/" style="font-size: 10.00px;">mvc</a><a href="/tags/note/" style="font-size: 10.00px;">note</a><a href="/tags/notes/" style="font-size: 17.50px;">notes</a><a href="/tags/plugin/" style="font-size: 10.00px;">plugin</a><a href="/tags/productivity/" style="font-size: 10.00px;">productivity</a><a href="/tags/programming/" style="font-size: 12.50px;">programming</a><a href="/tags/python/" style="font-size: 10.00px;">python</a><a href="/tags/reflow/" style="font-size: 10.00px;">reflow</a><a href="/tags/sqlite/" style="font-size: 10.00px;">sqlite</a><a href="/tags/st2/" style="font-size: 17.50px;">st2</a><a href="/tags/summaries/" style="font-size: 10.00px;">summaries</a><a href="/tags/system/" style="font-size: 10.00px;">system</a><a href="/tags/vim/" style="font-size: 10.00px;">vim</a><a href="/tags/vs2012/" style="font-size: 10.00px;">vs2012</a><a href="/tags/vs2013/" style="font-size: 10.00px;">vs2013</a><a href="/tags/web/" style="font-size: 10.00px;">web</a><a href="/tags/webdev/" style="font-size: 20.00px;">webdev</a><a href="/tags/webview/" style="font-size: 12.50px;">webview</a><a href="/tags/windows/" style="font-size: 15.00px;">windows</a>
  </div>
</div>


    	<footer id="footer" class="inner"><div class="copyright">
  
  &copy; 2015 chaoming.edc|blastmann
  
</div>



<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51731334-1', 'edi-c.com');
  ga('send', 'pageview');

</script></footer>
    </aside>


    <div id="hidden-navigationBar" class="navigationBar">
      <a href="/">@chaoming.edc blog</a>
    </div>
    <div id="main-col" class="alignright">
    <div id="wrapper">
      
<article class="post">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <div class="post-content">
  <header>
      
      
  
    <h1 class="title">让WinRT 8.1 Webview支持任意站点下的JS通知</h1>
  

      <time datetime="2014-08-04T14:10:00.000Z"><a href="/post/a-solution-for-any-hosts-to-notify-winrt-81-webview.html">8月 4 2014</a></time>
      
  </header>
    <div class="entry">
      
        <h2 id="前言">前言</h2>
<p>在使用WebBrowser\Webview一类的控件时，一般都免不了与JS打交道。从WP7开始，微软的WebBrowser就支持使用<code>ScriptNotify()</code>进行JS与C#代码间的交互，到WinRT下的Webview仍然有这么一个API供开发者使用，但适用情况有些许改变。</p>
<h2 id="问题描述">问题描述</h2>
<p>WinRT 8.1下，微软增强了Webview控件的大部分功能，同时也废弃了几个允许脚本通知（ScriptNotify)的属性。关于ScriptNotify，在8.1的帮助文档里面有这么一段注释：</p>
<blockquote>
<p>To enable an external web page to fire the ScriptNotify event when calling window.external.notify, you must include the page’s URI in the ApplicationContentUriRules section of the app manifest. (You can do this in Visual Studio on the Content URIs tab of the Package.appxmanifest designer.) The URIs in this list must use HTTPS and may contain subdomain wildcards (for example, “<a href="https://*.microsoft.com" target="_blank">https://*.microsoft.com</a>“), but they can’t contain domain wildcards (for example, “<a href="https://*.com" target="_blank">https://*.com</a>“ and “<a href="https://*.*" target="_blank">https://*.*</a>“). The manifest requirement does not apply to content that originates from the app package, uses an ms-local-stream:// URI, or is loaded using NavigateToString.<br>Note  If you have more then one subdomain, you must use one wildcard for each subdomain. For example, “<a href="https://*.microsoft.com" target="_blank">https://*.microsoft.com</a>“ matches with “<a href="https://any.microsoft.com" target="_blank">https://any.microsoft.com</a>“ but not with “<a href="https://this.any.microsoft.com" target="_blank">https://this.any.microsoft.com</a>.”<br>These changes do not affect apps compiled for Windows 8, even when running on Windows 8.1.</p>
<p>AllowedScriptNotifyUris, AnyScriptNotifyUri, and AllowedScriptNotifyUrisProperty are not supported in apps compiled for Windows 8.1.</p>
</blockquote>
<p>也就是说，只有在应用开发过程中，开发者主动添加在<code>Package.appxmanifest</code>中的，并且只能是HTTPS下的Uri才可以进行脚本的主动通知。开发者无法直接地对非HTTPS的站点进行JS注入后的主动通知，而且需要维护一个庞大的白名单。</p>
<h2 id="解决思路：微软的示例代码中有一段神奇的注释">解决思路：微软的示例代码中有一段神奇的注释</h2>
<p>在微软给出的Webview示例中，有这么一段注释：</p>
<blockquote>
<p>Content loaded using the NavigateToString() method; or ms-appx-web, ms-appdata, ms-webview-stream:// URI schemes can get the result back automatically. </p>
</blockquote>
<p>有两种情况，Webview可以无视上面描述的通知限制。</p>
<ol>
<li>使用<code>NavigateToString()</code>显示的页面</li>
<li>使用<code>ms-appx-web</code>、<code>ms-appdata</code>和<code>ms-webview-stream://</code>导航显示的页面</li>
</ol>
<p>那么，这个问题就转变成：能否在其它网站页面中引入一个本地页面作为与本地C#代码进行交互呢？</p>
<p>答案是可以的。</p>
<p>经过测试，我们完全可以在应用中引入一个HTML文档，文档中只需要简单地在页面中封装<code>window.external.notify()</code>这个JS函数。然后在任意页面中通过JS创建<code>iframe</code>标签并使用<code>ms-appx-web</code>协议引用这个本地的HTML文档。只要HTML文档可以正常加载，那么问题将转化为：如何对<code>iframe</code>进行跨域通信？</p>
<p>关于<code>iframe</code>的跨域通信，网上有不少的解决方法。在我的示例中只使用了<code>postMessage</code>这个HTML5 API进行通信（不兼容IE8以下）。</p>
<p><img src="https://xbyjdw.bn1.livefilestore.com/y2pB5LW1JARe7w32dZ04XD6eijpeYMoYH9g8tKZKnIoJib-7W5OVK8B5ypBVHG6A0zjIMoYqIanjg6fBOXg86IIro4UTz_isP0gsXvEaF_L9C4/any-uri-notify.png?psid=1" alt="any-uri-notify"></p>
<p>示例代码下载：<a href="https://www.dropbox.com/s/tv2sq7qt9ybuopz/Control_WebView.zip" target="_blank">点击下载</a>。</p>
<p>PS：微软限制JS的通知当然是出于安全性的考虑了，所以我们在使用这种方法的时候，也需要好好考虑一下会不会造成什么安全隐患。另外，我个人是希望JS通知这东西能少则少，毕竟性能也不是很好，建议尽量是减少使用的。</p>

	 
	     <p style="margin:20px 0; color:#9f9f9f; font-size:12px;">
<span>Posted by <a style="color:#9f9f9f;" href="http://weibo.com/newdings/"><strong>@cmm是muffinman_</strong></a> - 8月 4 2014</span><br />
<span style="line-height:13px;">如需转载，请注明： 本文来自 <a style="color:#9f9f9f;" href="http://blog.edi-c.com"><strong>@chaoming.edc blog</strong></a></span>
</p>
       	 
      
    </div>
    <footer>
      
	 
     		  
       		
  
  <div class="tags">
    <a href="/tags/winrt/">winrt</a>, <a href="/tags/webview/">webview</a>
  </div>

     		  
       	 
      
      <div class="clearfix"></div>
    </footer>
  </div>
</article>


<section id="comment">
  <h1 class="title">留言</h1>




<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'blastmannonscriptogram'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>


</section>

</div>
    </div>
    <div class="tabbar" onload="divideTabBar()">
	
      <div class="tabbaritem"><a class="next" href="/">Home</a></div>
    
      <div class="tabbaritem"><a class="next" href="/archives/">Archives</a></div>
    
      <div class="tabbaritem"><a class="next" href="/about/">About</a></div>
    
      <div class="tabbaritem"><a class="next" href="/atom.xml">Subscribe</a></div>
    
</div>


  </div>

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="http://ajax.aspnetcdn.com/ajax/jQuery/jquery-1.8.0.min.js"></script>
</body>
</html>